
//重写toFixed 四舍五不入的bug
Number.prototype.toFixed = function(s) {  
            var changenum = (parseInt(this * Math.pow(10, s) + 0.5) / Math.pow(10, s)).toString();  
            index = changenum.indexOf(".");  
            if (index < 0 && s > 0) {  
                changenum = changenum + ".";  
                for (i = 0; i < s; i++) {  
                    changenum = changenum + "0";  
                }  
            } else {  
                index = changenum.length - index;  
                for (i = 0; i < (s - index) + 1; i++) {  
                    changenum = changenum + "0";  
                }  
            }  
            return changenum;  
        } 
		
		
		//增加一条记录初始化
		
	function add(p){
		
			//console.log(p);
		var isTd1=$(p).find('td:first select');
		g=isTd1.closest("tr");//整行的全部变量
    //放款提奖表，线下本息费账，融资档案,投资档案,预留返还账,融资项目表,线上项目表,线上日记账,线上本息费账
		var w=['b801','z101','b201','b701','z301','b112','x103','x302','x201']		
		if ( w instanceof Array){			 
			for (var i=0;i<w.length;i++) {
				if (isTd1.hasClass(w[i])){
					console.log(isTd1.hasClass(w[i]));					
				    cal.ajaxs[w[i]] && cal.ajaxs[w[i]](isTd1) 				
				}
			} 
		}     				
       }
		
document.addEventListener('DOMContentLoaded',function(){
    function getFont(){
        var html1=document.documentElement; 
        var agreeP = document.getElementById('ag');
        var screen=html1.clientHeight;
		var ww=screen*0.7;
		var p=ww+'px'
		$('#bjui-collapse0').css('overflow','auto');
		$('#bjui-collapse0').css('height',p);
		//$('.panel .panel-default .collapse .in').height();         
    }
    getFont();   
    window.onresize=function(){
        getFont();
    }
},false)

 

var stop = false;
var set = setInterval(function(){
    $('#main-table .zhuyaoCon').off('scroll');
    $('#main-table .zhuyaoCon').on('scroll',function() {
       // console.log('scroll');
        var srollLeft = $(this).scrollLeft(); //滚动条距顶部距离(页面超出窗口的高度)
        var trwidth=$('#main-table .floatTr').width();
        var iframeview=$(this).width()
        $('#main-table .floatTr span.floatBtn').css('right',trwidth-srollLeft-iframeview)
        scrollEvent($('tr.floatTr td.floatBtn'),srollLeft)
        scrollEvent($('tr.floatTr th.floatBtn'),srollLeft)
    })
},1000);

function scrollEvent(dom,srollLeft){
	$(dom).css({'z-index':99,'left':srollLeft})
}

 

function map(c){

//	console.trace();
	g=$(c).closest("tr");
	var a= $(c).attr('class');
	var p;
	if(/\s/.test(a)){
		 p=a.split(' ')[0];
		 console.log('autoForm:'+p);
	}else{
		p=a;
		console.log('autoForm:'+p);
	}

    if(tgh_field_show.indexOf(p)!=-1){
        var cc=$(c).closest("td").next().find("input[type=text]");
        ($(c).prop("checked"))?cc.val(FormatDate(new Date())):cc.val('');
    }else{
        cal.action(cal.zidian[p]);
    }
//计算到期时间

       var datarry={
		   '.b606':['.b607','.b608','.b609'],
		   '.x105':['.x108','.x109','.x117'],
		   '.b704':['.b705','.b706','.b707'],
		   '.b108':['.b109','.b110','.b111']
	   }
	   
	   for (var i in datarry) {
		   if ('.'+p==i||'.'+p==datarry[i][0]||'.'+p==datarry[i][1]){
			   if (p=='b108'||p=='b109'||p=='b110'){
		  console.log( jianyitian(jisuanriqi(c,-1,i,datarry[i][0],datarry[i][1],datarry[i][2]),-1));
		  $(c).closest("tr").find(datarry[i][2]).val(jianyitian(jisuanriqi(c,-1,i,datarry[i][0],datarry[i][1],datarry[i][2]),-1));
		  }else{
			  
			$(c).closest("tr").find(datarry[i][2]).val(jisuanriqi(c,-1,i,datarry[i][0],datarry[i][1],datarry[i][2]));  
		  }
		   }
		   
	   }
	   
	//jisuanriqi(c,-1,'.b606','.b607','.b608','.b609');
	//jisuanriqi(c,-1,'.x105','.x108','.x109','.x117');
	//jisuanriqi(c,-1,'.b704','.b705','.b706','.b707');
	//jisuanriqi(c,-1,'.b108','.b109','.b110','.b111');

     //  ajax 获取
	
          //放款提奖表，线上本息费账，融资档案,投资档案,预留返还账,融资项目表,线上项目表,线上日记账,线上本息费账
		var w=['b801','z101','b201','b701','z301','b112','x103','x302','x201']
		
		if ( w instanceof Array){
			
			for (var i=0;i<w.length;i++) {
				if (p==w[i]){
				cal.ajaxs[w[i]] && cal.ajaxs[w[i]](c) 
				console.log('ajax');
				}
			} 
		}       
		

		//融资项目表2016.11.23
		/*if (p=='b108' && $(c).val()!=0||p=='b109'||p=='b110'){
		var v={daoqiriqi:$(c).val(),yue:$(c).closest("tr").find('.b109').val(),tian:$(c).closest("tr").find('.b110').val()};//ID 值
	  myAjax('/index/apifengkong/onb111', v, function(logRet) {
		  var data=logRet.hetongbianhaoInfo;
		   console.log(logRet);
              for (var i in data){                  
				$(c).closest("tr").find('.'+i).val(data[i]);                 			
			  }
              }, true);
		}*/

          if (p=='b703' && $(c).val()!=0){
			var valObj = $(c).val(); 
			valObj = cal.parseNum(valObj);
			var s= (valObj*1).toFixed(2);
			$(c).val(parseFloat(s))
		   }
          

      var usercall = $(c).attr('usercall')
      if ( usercall )
      {
    	  window[usercall](c);
      }
      

		
}

function jisuanriqi(c,jian,f,yue,ri,jieguo){

		//复制
		
		if (f=='.x105'){
			
			$(c).closest("tr").find('.x113').val($(c).closest("tr").find(f).val())
		}

	//获取几月或几天后的日期
	var jttp=$(c).closest("tr").find(f).attr('value');
	console.log(jttp);
	  var dangqianshijian=$(c).closest("tr").find(f).val();
	  
	   var yuec=$(c).closest("tr").find(yue).val();
	   var ric=$(c).closest("tr").find(ri).val();
	   console.log('起始日期：'+dangqianshijian)
	   console.log('月：'+yuec)
	   console.log('日'+ric)
	   var jieguosum;
	if ((yuec==''||  parseInt(yuec)==0) && ric!=''  ){
		console.log(parseInt(ric));
		
		jieguosum=adddays(dangqianshijian,parseInt(ric))
		
	}
	
	if ( (ric=='' || parseInt(ric)==0) && yuec!=''){
		console.log(parseInt(yuec));
		var tian=dangqianshijian.split('-')[2];
		var ot=getMonths(dangqianshijian,parseInt(yuec),-1);
		
		if (parseInt(tian)<parseInt(ot.day)){
			console.log('结束日期：'+ot.year+'-'+ot.mouth+'-'+tian)
			jieguosum=ot.year+'-'+ot.mouth+'-'+tian;
			//$(c).closest("tr").find(jieguo).val(jieguosum);
		}else{
			jieguosum=ot.year+'-'+ot.mouth+'-'+ot.day;
			console.log('结束日期：'+ot.year+'-'+ot.mouth+'-'+ot.day)
			//$(c).closest("tr").find(jieguo).val(jieguosum);
		}
	}
	
	if ( ric!='' && yuec!=''){
		           if (dangqianshijian){
					   var tian=dangqianshijian.split('-')[2];
				   }
		
		var ot=getMonths(dangqianshijian,parseInt(yuec),0);
		var days=ot.sumday+parseInt(ric);
		//console.log(days);
		//console.log(ot.sumday);
		var dangqians;
		if (parseInt(tian)<parseInt(ot.day)){
			console.log('结束日期：'+ot.year+'-'+ot.mouth+'-'+tian)
			dangqians=ot.year+'-'+ot.mouth+'-'+tian;
		}else{
			console.log('结束日期：'+ot.year+'-'+ot.mouth+'-'+ot.day)
			dangqians=ot.year+'-'+ot.mouth+'-'+ot.day;
		}
		//
		//
		jieguosum=adddays(dangqians,parseInt(ric))
		//$(c).closest("tr").find(jieguo).val(jieguosum);
		
	}
	console.log(jieguosum);
	
	//复制end
	//$(c).closest("tr").find(jieguo).val(jieguosum);
	
	return jieguosum
	
}



function autofill(c,url,e,se){
	var a= $(c).attr('class');
	var p;
	if(/\s/.test(a)){
		 p=a.split(' ')[0];
		
	}else{
		p=a;
		
	}
	
	if (p==e && $(c).val()!=0){
		var v={id:$(c).val()};//ID 值
	 
	  myAjax(url, v, function(logRet) {
		  var data=logRet.hetongbianhaoInfo;
		   console.log(logRet);
              for (var i in data){
				if (i== searcher(i,se)){					  
					  $(c).closest("tr").find('.'+i).selectpicker('val', data[i]);
				  }else{			  
				$(c).closest("tr").find('.'+i).val(data[i]); 
                 }				  
			  }
              }, true);
		}	

}
	
function searcher(n,data){
	var value;
	for (var i=0;i<data.length;i++){				
					if   (n==data[i]){					
						value=data[i]
					}
			  }
			  return value;
			  	
}
	
	
var tgh_field_show = ['d105','d107','d109','d111','d113','d115','d117'];

var cal={
   getInputVal:function (arr){
        if ( arr instanceof Array){
			var valObj = {};
			for(var i=0;i<arr.length;i++){
				var key = [arr[i]];				
				valObj[key] = g.find('.'+key).val() || 0				
			}			
			return valObj;
		}
   },
   setValue:function (vals,id){

       g.find('.'+id).val(vals).attr("readonly","readonly");
	   	cal.action(cal.zidian[id]);
	     
   },
   action:function (w){
   		if ( w instanceof Array) for (var i=0;i<w.length;i++)  this.fnzidian[w[i]] && this.fnzidian[w[i]]()       
   },
   
   parseNum : function(obj){  		
   		var rep = /[\u4e00-\u9fa5]/g;
   		for(var i in obj){
   			if(rep.test(obj[i])){
   				continue 
   			}else{
   				obj[i] = parseFloat(obj[i])
   				
   			}
   		}
   		var newObj = obj;
   		return newObj
   },
   
   
   ajaxs:{
	   b801:function(c){   
		   var v={id:$(c).val()};//ID 值
	      myAjax('/index/apifengkong/onhetongbianhao', v, function(logRet) {
		  var data=logRet.hetongbianhaoInfo;
		   console.log(logRet);
              for (var i in data){				
				$(c).closest("tr").find('.'+i).val(data[i]);  				  
			  }
              }, true);
			  cal.action(cal.zidian['b804']);//放款提奖表 借款额[万元]  
	   },
	   
	   	z101:function(c){
			
			var v={id:$(c).val()};//ID 值
	  myAjax('/index/apifengkong/onxianxiabenxifeizhang', v, function(logRet) {
		  var data=logRet.hetongbianhaoInfo;
		   console.log(logRet);
              for (var i in data){				
				$(c).closest("tr").find('.'+i).val(data[i]);  				  
			  }
              }, true);
			
		},
		
		b201:function(c){
			var v={id:$(c).val()};//ID 值
	  myAjax('/index/apifengkong/onb201', v, function(logRet) {
		  var data=logRet.hetongbianhaoInfo;
		   console.log(logRet);
              for (var i in data){				
				$(c).closest("tr").find('.'+i).val(data[i]);  				  
			  }
              }, true);
		},
		
		
		
		b701:function(c){
			
			var v={id:$(c).val()};//ID 值
	  myAjax('/index/apifengkong/onb701', v, function(logRet) {
		  var data=logRet.hetongbianhaoInfo;
		   console.log(logRet);
              for (var i in data){				
				$(c).closest("tr").find('.'+i).selectpicker('val', data[i]);  				  
			  }
              }, true);
			
			
		},
		
		z301:function(c){
			
			var v={id:$(c).val()};//ID 值
	  myAjax('/index/apifengkong/onz301', v, function(logRet) {
		  var data=logRet.hetongbianhaoInfo;
		   console.log(logRet);
              for (var i in data){
                  if ( i== 'z302'|| i=='z303'|| i=='z306'|| i=='z309'){					  
					  $(c).closest("tr").find('.'+i).selectpicker('val', data[i]);
				  }else{			  
				$(c).closest("tr").find('.'+i).val(data[i]); 
                 }				
			  }
              }, true);
			
			
			
		},
		
			//融资项目表
		b112:function(c){
			
			
			var v={fuxifeifangshi:$(c).val(),yue:$(c).closest("tr").find('.b109').val(),tian:$(c).closest("tr").find('.b110').val(),daoqiriqi:$(c).closest("tr").find('.b108').val()};//ID 值
	  myAjax('/index/apifengkong/onb113', v, function(logRet) {
		  var data=logRet.hetongbianhaoInfo;
		   console.log(logRet);
              for (var i in data){                 
				$(c).closest("tr").find('.'+i).val(data[i]); 			
			  }
              }, true); 
		},
		
		
		x103:function(c){
		var v={id:$(c).val()};//ID 值
	  myAjax('/index/apifengkong/onx103', v, function(logRet) {
		  var data=logRet.hetongbianhaoInfo;
		   console.log(logRet);
              for (var i in data){				
				$(c).closest("tr").find('.'+i).val(data[i]);  				  
			  }
              }, true);	
		},
		
		
		
		x302:function(c){
			
			
			var v={zhanghao:$(c).val()};//ID 值
	  myAjax('/index/apifengkong/onx302', v, function(logRet) {
		  var data=logRet.hetongbianhaoInfo;
		   console.log(logRet);
              for (var i in data){				
				$(c).closest("tr").find('.'+i).val(data[i]);  				  
			  }
              }, true);
			  },

		x201:function(c){
			
			var v={id:$(c).val()};//ID 值
	  myAjax('/index/apifengkong/onx201', v, function(logRet) {
		  var data=logRet.hetongbianhaoInfo;
		   console.log(logRet);

              for (var i in data){				
				if (i== 'x202'){					  
					  $(c).closest("tr").find('.'+i).selectpicker('val', data[i]);
				  }else{			  
				$(c).closest("tr").find('.'+i).val(data[i]); 
                 }				  
			  }			  
              }, true);
			
			
		},
		
		
   },
		
   //字段和函数关系表
   fnzidian:{ 
   
       
   		'x111':function(){
			var valObj = cal.getInputVal(['x102']); 
			valObj = cal.parseNum(valObj)
			var s;
			s=1;
			cal.setValue(s,'x111');
		},

       'b118':function(){  
       		var valObj = cal.getInputVal(['b112','b117','b109','b110']); 
       		valObj = cal.parseNum(valObj)
       		//console.log(typeof valObj.b112)
       		//console.log(valObj)
	        var s;		 
			if (valObj.b112=="3"){
		        //满足的计算公式
		        s = ((valObj.b117*valObj.b109) + (valObj.b117*valObj.b110/30)).toFixed(2)
		        
			}else{		 
			   s = parseFloat(valObj.b117).toFixed(2);
			}
	    	
		    cal.setValue(s,'b118');
		
	
        },
		
		'b911':function(){
        	var valObj = cal.getInputVal(['b910','b909']);        	
        	valObj = cal.parseNum(valObj)        	
        	var s ;
			var w=valObj.b910;			
			if (valObj.b909==3){				
					if (w<2){					
					s=12
				}else if (w>=2&& w<5){					
					s=15					
				}else if(w>=5&& w<10){
					s=20
				}else if (w>=10&& w<15){					
					s=25
				}else if (w>=15 && w<20){
					s=30
				}else if (w>=20){					
					s=40
				}
			}else if (valObj.b909==1||valObj.b909==2){
				if (w<20){					
					s=30;
				}else{					
					s=40;					
				}
				
			}
        	cal.setValue(s,'b911');
		
        },
        'b119':function(){
        	var valObj = cal.getInputVal(['b107','b118']);        	
        	valObj = cal.parseNum(valObj)
        	//console.log(valObj)
        	var s = (valObj.b107*valObj.b118*10000*0.01).toFixed(2);
        	cal.setValue(s,'b119');
		
        },
		
		'b1211':function(){
        	var valObj = cal.getInputVal(['b107','b121']);        	
        	valObj = cal.parseNum(valObj)
        	//console.log(valObj)
        	var s = (valObj.b107*valObj.b121*10000*0.01).toFixed(2);
        	cal.setValue(s,'b1211');
		
        },
        
        b123 : function(){
        	var valObj = cal.getInputVal(['b107','b109','b110','b122']);
        	valObj = cal.parseNum(valObj)
        	//console.log(valObj)
        	var s = (((valObj.b122*valObj.b109)+(valObj.b122*valObj.b110/30))*valObj.b107*10000*0.01).toFixed(2);
        	cal.setValue(s,'b123');
		
        },
        
        b126 : function(){
        	var valObj = cal.getInputVal(['b107','b109','b110','b125']);
        	valObj = cal.parseNum(valObj)
        	//console.log(valObj)
        	if(valObj.b110 && valObj.b107){  //处理分母为0的情况
        		console.log(123)
        		var s = (valObj.b125/valObj.b107/10000/(valObj.b109*30+valObj.b110)/30).toFixed(2);        		       		
        		cal.setValue(s,'b126');
				
        	}       	
        	
        },
        
        b128 : function(){
        	var valObj = cal.getInputVal(['b127','b109','b110']);
        	valObj = cal.parseNum(valObj)
        	//console.log(valObj)
        	var s = (valObj.b127*valObj.b109 + (valObj.b127*valObj.b110)/30).toFixed(2);
        	cal.setValue(s,'b128');
			
        },
        
        b129 : function(){
        	var valObj = cal.getInputVal(['b107','b128']);
        	valObj = cal.parseNum(valObj);
        	//console.log(valObj);       	
        	var s = (valObj.b107*valObj.b128*10000*0.01).toFixed(2);
        	cal.setValue(s,'b129');
		
        },
        
        b131 : function(){
        	var valObj = cal.getInputVal(['b117','b121','b122','b126','b127']);
        	valObj = cal.parseNum(valObj);
        	//console.log(valObj);       	
        	var s = (valObj.b117+valObj.b121+valObj.b122+valObj.b127+valObj.b126).toFixed(2);
        	cal.setValue(s,'b131');
		
        },
        
        b132 : function (){
        	var valObj = cal.getInputVal(['b117','b121','b122','b126']);
        	valObj = cal.parseNum(valObj);
        	//console.log(valObj);
        	var s = (valObj.b117+valObj.b121+valObj.b122+valObj.b126).toFixed(2);
        	cal.setValue(s,'b132');
			
        },
        
        b134 : function(){
        	var valObj = cal.getInputVal(['b107','b133']);
        	valObj = cal.parseNum(valObj);
        	//console.log(valObj);
        	var s = (valObj.b107*valObj.b133*10000*0.01).toFixed(2);
        	cal.setValue(s,'b134');
			
        },
        
        b415 : function(){
        	var valObj = cal.getInputVal(['b413','b414','b410']);
        	valObj = cal.parseNum(valObj);
        	//console.log(valObj);
        	if(valObj.b410){   //处理分母为0的情况
        		var s = ((valObj.b413+valObj.b414)/valObj.b410*100).toFixed(2);
				s=Math.round(s);
        		cal.setValue(s,'b415');
        	}
        	
        },
        
        b613 : function(){
        	var valObj = cal.getInputVal(['b605','b607','b608','b612']);
        	valObj = cal.parseNum(valObj);
        	//console.log(valObj);
        	var s ;
        	if(valObj.b607 !=0){
        		s = (valObj.b605*valObj.b612*10000*0.01).toFixed(2)
        	}else{
        		s = (valObj.b605*valObj.b612*10000*0.01/30*valObj.b608).toFixed(2)
        	}
        	cal.setValue(s,'b613');
        },
        
        b614 : function(){
        	var valObj = cal.getInputVal(['b607','b608','b613']);
        	valObj = cal.parseNum(valObj);
        	//console.log(valObj);
        	var s ;
        	if(valObj.b607 == 0){
        		s = (valObj.b613).toFixed(2);
        	}else{
        		s = (valObj.b613*valObj.b607 + valObj.b613/30*valObj.b608).toFixed(2);
        	}
        	cal.setValue(s,'b614');
        },
        
        b617 : function(){
        	var valObj = cal.getInputVal(['b605','b607','b608','b616']);
        	valObj = cal.parseNum(valObj);
        	//console.log(valObj);
        	var s ;
        	if(valObj.b607 != 0){
        		s = (valObj.b605*valObj.b616*10000*0.01).toFixed(2);
        	}else{
        		s = (valObj.b605*valObj.b616*10000*0.01/30*valObj.b608).toFixed(2);
        	}
        	cal.setValue(s,'b617');
        },
        
        b618 : function(){
        	var valObj = cal.getInputVal(['b607','b608','b617']);
        	valObj = cal.parseNum(valObj);
        	
        	var s ;
        	if(valObj.b607 == 0){
        		s = (valObj.b617).toFixed(2);
        	}else{
        		s = (valObj.b617*valObj.b607+(valObj.b617/30)*valObj.b608).toFixed(2);
        		}

        	cal.setValue(s,'b618');
        },
        
        b811 : function(){
        	var valObj = cal.getInputVal(['b804','b805','b810']);
        	valObj = cal.parseNum(valObj);
        	
        	var s = (valObj.b804*valObj.b805*valObj.b810*10000*0.01).toFixed(2);
        	
        	cal.setValue(s,'b811');
        },
		//增加
		 b812 : function(){
        	var val = cal.getInputVal(['b807','b805','b806','b812']);
        	valObj = cal.parseNum(val);
			var s=valObj.b812;
        	if (val.b807=='1'){
				console.log(1);
				s = ((valObj.b805-1)/valObj.b805).toFixed(2);				
			}else{				
				if (valObj.b806==0){					
					s = 0;
				}
				
				if (valObj.b806==1.08){					
					s = 20;
				}
				
				if (valObj.b806==1.3){					
					s = 30;
				}
				
				if (valObj.b806==1.5){					
					s = 40;
				}
				
			}
        	 
        	cal.setValue(s,'b812');
        	
        },
        
        b814 : function (){
        	var valObj = cal.getInputVal(['b811','b824','b819']);
        	valObj = cal.parseNum(valObj);       	
        	var s = (valObj.b811-valObj.b824-valObj.b819).toFixed(2);        	
        	cal.setValue(s,'b814');
        },
        
        b815 : function(){
        	var valObj = cal.getInputVal(['b814','b812']);
        	valObj = cal.parseNum(valObj);       	
        	var s = (valObj.b814*valObj.b812*0.01).toFixed(2);        	
        	cal.setValue(s,'b815');
        },
        //放款提奖表中，经理预留计算错误。
        b816 : function(){
        	var valObj = cal.getInputVal(['b814','b815']);
        	valObj = cal.parseNum(valObj);       	
        	var s = (valObj.b814-valObj.b815).toFixed(2);        	
        	cal.setValue(s,'b816');
        },
        
        b819 : function(){
        	var valObj = cal.getInputVal(['b804','b805','b818']);
        	valObj = cal.parseNum(valObj);
        	var s = (valObj.b804*valObj.b805*valObj.b818*10000*0.01*0.001).toFixed(2);        	
        	cal.setValue(s,'b819');
        },
        
        b820 : function(){
        	var valObj = cal.getInputVal(['b819','b812']);
        	valObj = cal.parseNum(valObj);
        	var s = (valObj.b819*valObj.b812*0.01).toFixed(2);
        	
        	cal.setValue(s,'b820');
        },
        
        b821 : function(){
        	var valObj = cal.getInputVal(['b820','b819']);
        	valObj = cal.parseNum(valObj);
        	var s = (valObj.b819-valObj.b820).toFixed(2);
        	cal.setValue(s,'b821');
        },
        
        b824 : function(){
        	var valObj = cal.getInputVal(['b804','b805','b823']);
        	valObj = cal.parseNum(valObj);
        	var s = (valObj.b804*valObj.b805*valObj.b823*10000*0.01*0.001).toFixed(2);
        	cal.setValue(s,'b824');
        },
        
        b825 : function(){
        	var valObj = cal.getInputVal(['b824','b812']);
        	valObj = cal.parseNum(valObj);
        	var s = (valObj.b824*valObj.b812*0.01).toFixed(2);
        	cal.setValue(s,'b825');
        },
        
        b826 : function(){
        	var valObj = cal.getInputVal(['b824','b825']);
        	valObj = cal.parseNum(valObj);
        	var s = (valObj.b824-valObj.b825).toFixed(2);
        	cal.setValue(s,'b826');
        },
		
		
		//增加
		 b828 : function(){
        	var val = cal.getInputVal(['b804']);
        	valObj = cal.parseNum(val);
			var s;
			var w=valObj.b804;
        	if (valObj.b804 !=''){
				if (w>=30&& w<100){					
					s=300					
				}else if(w>=100&& w<300){
					s=500
				}else if (w>=300&& w<1000){					
					s=800
				}else if (w>=1000){
					s=1200
				}
						
			}else{				
				
				s=0;
			}
        	 
        	
        	cal.setValue(s,'b828');
        },
		
		//增加
		 b830 : function(){
        	var val = cal.getInputVal(['b807','b808']);
        	valObj = cal.parseNum(val);
			var s;
        	if (val.b807=='1'){
				s = 0;				
			}else{				
				if (val.b808=='1'){					
					s = 200;
				}
				
				if (val.b808=='2'){					
					s = 100;
				}

			}
        	 
        	
        	cal.setValue(s,'b830');
        },
        
        b912 : function(){
        	var valObj = cal.getInputVal(['b906','b911']);
        	valObj = cal.parseNum(valObj);
        	var s = (valObj.b906*valObj.b911*10000*0.01).toFixed(2);
        	cal.setValue(s,'b912');
        },
        
        b915 : function(){
        	var valObj = cal.getInputVal(['b906','b914']);
        	valObj = cal.parseNum(valObj);
        	var s = (valObj.b906*valObj.b914*10000*0.01).toFixed(2);
        	cal.setValue(s,'b915');
        },
        
        b918 : function(){
        	var valObj = cal.getInputVal(['b906','b917']);
        	valObj = cal.parseNum(valObj);
        	var s = (valObj.b906*valObj.b917*10000*0.01).toFixed(2);
        	cal.setValue(s,'b918');
        },
        
        b921 : function(){
        	var valObj = cal.getInputVal(['b906','b920']);
        	valObj = cal.parseNum(valObj);
        	var s = (valObj.b906*valObj.b920*10000*0.01).toFixed(2);
        	cal.setValue(s,'b921');
        },
        
        b924 : function(){
        	var valObj = cal.getInputVal(['b906','b923']);
        	valObj = cal.parseNum(valObj);
        	var s = (valObj.b906*valObj.b923*10000*0.01).toFixed(2);
        	cal.setValue(s,'b924');
        },
        
        b307:function(){	
			var valObj = cal.getInputVal(['b306','b303']);
			console.log(String(valObj.b306));
			
			if (valObj.b303=='1'){
			if (valObj.b306!=0){
				console.log(valObj.b306.substr( -2, 1)%2 ? 'm' : 'f');
			var c=valObj.b306.substr( -2, 1)%2 ? 'm' : 'f';
			if (c=='m'){  cal.setValue('男','b307');      }else{cal.setValue('女','b307');}	
			}
			}else{
				
				cal.setValue('','b307')
				
			}
			
		},
		b308:function(){	
			var valObj = cal.getInputVal(['b306','b303']);
			
			if (valObj.b303=='1'){
			if (valObj.b306!=0){
				
				valObj.b306.substr(-12, 8);
			console.log(valObj.b306.substr(-12, 8));
			var c=valObj.b306.substr(-12, 8);
			  c=c.substr(0, 4);
			var date = new Date();
            c1= date.getFullYear()
			c1-c
			cal.setValue(c1-c,'b308'); 
				
			}
			}else{
				
				cal.setValue('','b308'); 
			}
			
			   
		},
		  //b结束
		
        
        'x320':function(){
		//[x304] + [x305] + [x306] + [x307] + [x308] + [x309] + [x310] + [x311] + [x313] + [x312] - [x314] - [x315] - [x318] - [x319] - [x317] - [x316]
		     var r=0, arr=[ 'x304','x305', 'x306','x307', 'x308','x309', 'x310','x311', 'x313','x312','x314', 'x315','x318', 'x319','x317','x316'];				 
			 r +=parseFloat(cal.getInputVal(arr).x304)+parseFloat(cal.getInputVal(arr).x305)+parseFloat(cal.getInputVal(arr).x306)+parseFloat(cal.getInputVal(arr).x307)+parseFloat(cal.getInputVal(arr).x308);
			 r +=parseFloat(cal.getInputVal(arr).x309)+parseFloat(cal.getInputVal(arr).x310)+parseFloat(cal.getInputVal(arr).x311)+parseFloat(cal.getInputVal(arr).x312)+parseFloat(cal.getInputVal(arr).x313);
			 var r1= r -parseFloat(cal.getInputVal(arr).x314)- parseFloat(cal.getInputVal(arr).x315)-parseFloat(cal.getInputVal(arr).x316)-parseFloat(cal.getInputVal(arr).x317)-parseFloat(cal.getInputVal(arr).x318)-parseFloat(cal.getInputVal(arr).x319);					
			r1=r1.toFixed(2);
			console.log(1232323);
			console.log(parseFloat(cal.getInputVal(arr).x304)-parseFloat(cal.getInputVal(arr).x315));
			cal.setValue(r1,'x320');			              
		},
		'x210':function(){
		//[x205] + [x208] + [x207] + [x206] + [x209]
		   var r=0,arr=[ 'x205','x208', 'x207','x206', 'x209'];				 
			 r +=parseFloat(cal.getInputVal(arr).x205)+parseFloat(cal.getInputVal(arr).x208)+parseFloat(cal.getInputVal(arr).x207)+parseFloat(cal.getInputVal(arr).x206)+parseFloat(cal.getInputVal(arr).x209);		
			r=r.toFixed(2);
			cal.setValue(r,'x210');		
		},
		'x116':function(){
       //[x106] - [x115]
          var r=0,	arr=[ 'x106','x115'];				 
			  r +=parseFloat(cal.getInputVal(arr).x106)-parseFloat(cal.getInputVal(arr).x115);		
			  r=r.toFixed(2);
			  cal.setValue(r,'x116');	
		},
		
		'x114':function(){
            //[x106] - [x112]
           var r=0;	 arr=[ 'x106','x112'];				 
			 r +=parseFloat(cal.getInputVal(arr).x106)-parseFloat(cal.getInputVal(arr).x112);		
			r=r.toFixed(2);
			cal.setValue(r,'x114');	
		},
		
		'x112':function(){
           //[x111] * 0.01 * [x106]
           var r=1;			 
			 var arr=['x106','x111'];				 
			 r *=parseFloat(cal.getInputVal(arr).x106)*parseFloat(cal.getInputVal(arr).x111)*0.01;		
			r=r.toFixed(2);
			cal.setValue(r,'x112');	
		},
		
		'z314':function(){
          //[z313] - 1
           var r=0;			 
			 var arr=['z313'];				 
			 r =parseInt(cal.getInputVal(arr).z313)-1;		
		     r=r.toFixed(2);
			cal.setValue(r,'z314');	
		},	
		'z311':function(){
          //IIF([z314] = 0 , [z310] , IsNull ([z310],0) / IsNull ([z314],1))
		   var arr=['z314','z310'];	
		   var z314=(parseInt(cal.getInputVal(arr).z314)==0)?1:parseInt(cal.getInputVal(arr).z314);
		  var r=(parseInt(cal.getInputVal(arr).z314)==0)?parseInt(cal.getInputVal(arr).z310):parseInt(cal.getInputVal(arr).z310)/z314;
		  r=r.toFixed(2);
			cal.setValue(r,'z311');	
		},

         'z308':function(){
           //IIF([z314] = 0 , [z307] , IsNull ([z307],0) / IsNull ([z314],1))
		   var arr=['z314','z307'];	
		   var z314=(parseInt(cal.getInputVal(arr).z314)==0)?1:parseInt(cal.getInputVal(arr).z314);
		  var r=(parseInt(cal.getInputVal(arr).z314)==0)?parseInt(cal.getInputVal(arr).z307):parseInt(cal.getInputVal(arr).z307)/z314;
		  r=r.toFixed(2);
			cal.setValue(r,'z308');	
		},

		 'z305':function(){
         	//IIF([z314] = 0 , [z304] , IsNull ([z304],0) / IsNull ([z314],1))
		   var arr=['z314','z304'];	
		   var z314=(parseInt(cal.getInputVal(arr).z314)==0)?1:parseInt(cal.getInputVal(arr).z314);
		  var r=(parseInt(cal.getInputVal(arr).z314)==0)?parseInt(cal.getInputVal(arr).z304):parseInt(cal.getInputVal(arr).z304)/z314;
		  r=r.toFixed(2);
			cal.setValue(r,'z305');	
		},
        
		 'z112':function(){
         	//IsNull ([z108],0) + IsNull ([z111],0)
			 var r=0;	 arr=['z108','z111'];				 
			 r +=parseFloat(cal.getInputVal(arr).z108)+parseFloat(cal.getInputVal(arr).z111);		
			r=r.toFixed(2);
				cal.setValue(r,'z112');	
		},

		 'z111':function(){
         
		  var r=1, arr=['z108','z109','z110'];			  
		    r *=parseFloat(cal.getInputVal(arr).z108)*parseFloat(cal.getInputVal(arr).z109)*parseFloat(cal.getInputVal(arr).z110)*0.01;	
			r=r.toFixed(2);	
			cal.setValue(r,'z111');	
		},
		
		 'z108':function(){	
		    var r=0, arr=['z107','z105'];	
			 var yinfu=getMillisecondsToDaynum(g.find(".z106").val());
           if ((yinfu-getCurDayNum()<0) && (parseFloat(cal.getInputVal(arr).z105)>parseFloat(cal.getInputVal(arr).z107))){			
			   r=parseFloat(cal.getInputVal(arr).z105)-parseFloat(cal.getInputVal(arr).z107)
		   }else{r=0
		   }		   
		   r=r.toFixed(2);
			cal.setValue(r,'z108');	
		},
		 'z109':function(){
		  var r=0, arr=['z108'];	
           var yinfu=getMillisecondsToDaynum(g.find(".z106").val());		  
		  if (yinfu-getCurDayNum()<0 && parseFloat(cal.getInputVal(arr).z108)!=0){
			   r=getCurDayNum()-yinfu;
		   }else{r=0
		   }
			cal.setValue(r,'z109');	
		}
    },
    //字段影响关系表
   zidian:{
	   b910:['b911'],
	   b909:['b911'],
	   b306:['b308','b307'],
	   b303:['b308','b307'],
   		b107 : ['b119','b123','b126','b129','b134','b1211'],
   		b109 : ['b118','b123','b126','b128'],  
   		b110 : ['b118','b123','b126','b128'],  
    	b112 : ['b118'],
   	 	b117 : ['b118','b131','b132'],  	 
   	 	b118 : ['b119'],
   	 	b121 : ['b131','b132','b1211'],
   	 	b122 : ['b123','b131','b132'],
   	 	b125 : ['b126'],
   	 	b126 : ['b131','b132'],
   	 	b127 : ['b128','b131'],
   	 	b128 : ['b129'],
   	 	b133 : ['b134'],
   	 	
   	 	b410 : ['b415'],
   	 	b413 : ['b415'],
   	 	b414 : ['b415'],
   	 	
   	 	b605 : ['b613','b617'],
   	 	b607 : ['b613','b614','b617','b618'],
   	 	b608 : ['b613','b614','b617','b618'],
   	 	b612 : ['b613'],
   	 	b613 : ['b614'],
   	 	b616 : ['b617'],
   	 	b617 : ['b618'],
   	 	
   	 	b804 : ['b811','b819','b824','b828'],  	 	
		b805 : ['b811','b819','b824','b812','b828'],
		b806: ['b812',,'b828'],
		b807: ['b812','b830','b828'],
		b808: ['b830','b828'],
		b810 : ['b811','b828'],
		b811 : ['b814','b828'],
		b812 : ['b815','b820','b825','b828'],
		b814 : ['b815','b816','b828'],
		b815 : ['b816','b828'],
		b818 : ['b819','b828'],
		b819 : ['b814','b821','b820','b828'],
		b820 : ['b821','b828'],
		b823 : ['b824','b828'],
		b824 : ['b814','b825','b826'],
		b825 : ['b826'],
		
		b906 : ['b912','b915','b918','b921','b924'],		
		b911 : ['b912'],
		b914 : ['b915'],
		b917 : ['b918'],
		b920 : ['b921'],
		b923 : ['b924'],
		
		
		//b结束
		
		'x102':['x111'],
		'x304':['x320','x111'],
		'x305':['x320','x111'], 
		'x306':['x320','x111'],
		'x307':['x320','x111'], 
		'x308':['x320','x111'],
		'x309':['x320','x111'], 
		'x310':['x320','x111'],
		'x311':['x320','x111'], 
		'x313':['x320','x111'],
		'x312':['x320','x111'],
		'x314':['x320'], 
		'x315':['x320'],
		'x318':['x320'], 
		'x319':['x320'],
		'x317':['x320'],
		'x316':['x320'],
		'x205':['x210'],
		'x206':['x210'],
		'x207':['x210'],
		'x208':['x210'],
	    'x209':['x210'],	
		'x106':['x116','x114','x112'],
		'x115':['x116'],
		'x112':['x114'],
		'x111':['x112'],
		'z313':['z314'],
		'z314':['z311','z308','z305'],
		'z310':['z311'],
		'z307':['z308'],
		'z304':['z305'],
		'z108':['z112','z111','z109'],
		'z111':['z112'],
		'z109':['z111'],
		'z110':['z111'],
		'z106':['z109','z108'],
		'z105':['z108','z109'],
		'z107':['z108','z109']
   }
   
  
}


function FormatDate (strTime) {
    var date = new Date(strTime);
    return date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate();
}

function setDate(o){
   var cc=$(o).closest("td").next().find("input[type=text]");
	($(o).prop("checked"))?cc.val(adddays('2015-05-06',getdays('2015-05-06',2))):cc.val('');
}

function getdays(starttime,monthnum){
	var runnian=[31,29,31,30,31,30,31,31,30,31,30,31];
	var pinnian=[31,28,31,30,31,30,31,31,30,31,30,31];
	var dangyue=0;
	var day=0;
	  starttime = starttime.replace(new RegExp("-","gm"),"/");
	 //console.log(starttime);
    var now=new Date(starttime);
	//console.log(now.getMonth()+1);
	var dangyue=parseInt(now.getMonth()+1);
	var year=parseInt(now.getFullYear());
	//console.log(monthnum);
	var pos=dangyue+1;
	//console.log('位置'+pos);
	       for (var i=0;i < monthnum;i++){
			 //   console.log(i);
			      pos++;
			   console.log(year);
			   if (isLeapYear(year).value==28){
				   day=day+pinnian[pos-1];
			   }else{
				  day =day+runnian[pos-1]; 
			   }
		       
			    if (pos==12){
				  // dangyue=1;
				    pos=1;
					year+=1;
			   }
			   console.log(pos-1);
			
			   console.log(day);
	      }
	return day;
}
function getCurDayNum(){
	 return (new Date().getTime()/1000 / 60 / 60 / 24).toFixed(0);
}

function getMillisecondsToDaynum(date){
	var v=date.replace(new RegExp("-","gm"),"/");
	v= new Date(v).getTime();
	var days    = v / 1000 / 60 / 60 / 24;
	return days.toFixed(0);
}
     
function getMonths(starttime,monthnum){
	if (starttime){
		starttime = starttime.replace(new RegExp("-","gm"),"/");
		
	}
	
	var runnian=[31,29,31,30,31,30,31,31,30,31,30,31];
	var pinnian=[31,28,31,30,31,30,31,31,30,31,30,31];
	var dangyue=0; 
    var now=new Date(starttime);
	var dangyue=parseInt(now.getMonth()+1);
	var year=parseInt(now.getFullYear());
	console.log(dangyue);
	var pos=dangyue;
	 var sumday=0;
	  var tt;
	  var o={}
	       for (var i=0;i < monthnum;i++){
			    pos++; 
			    if (pos>12){
				  // dangyue=1;
				    pos=1;
					year+=1;
			   }
			   //console.log('天'+tt);
			  console.log('位置'+pos);
			   console.log(runnian[pos-1]);
	      }

		   if (isLeapYear(year).value==28){
				  console.log('平');
				  sumday+=pinnian[pos-1];
				   tt=pinnian[pos-1];
			   }else{
				 sumday+=runnian[pos-1];
				 tt =runnian[pos-1]; 
				  console.log('润');
			   } 
	      o.year=year;		  
		  if (pos<10){
			  
			o.mouth='0'+pos;  
		  }else{
			  o.mouth=pos;  
		  }
         o.sumday=sumday; 		  
		 o.day=tt; 
			  console.log(o.year+'年'+o.mouth+'月'+',当月'+tt+'天,'+sumday);
	 return o;

}




function jianyitian(gt,jian){
	console.log(gt);
	gt=gt.replace(new RegExp("-","gm"),"/");
	console.log(gt);
	 var now=new Date(gt).getTime()+(jian*24*60*60*1000);
	console.log(now)
	
	var newdate=new Date(now);
	
	
	return newdate.getFullYear()+"-"+(newdate.getMonth()+1)+"-"+newdate.getDate();  
}

function isLeapYear(pYear){
   
     if(!isNaN(parseInt(pYear))){
      if((pYear%4==0 && pYear%100!=0)||(pYear%100==0 && pYear%400==0)){
       return {'text':pYear+"是闰年！",value:29};
      }else{
	  return {'text':pYear+"是平年！",value:28};
      }
     }else{
      return {'text':"请输入正确年份！",value:0};
     }
}

function adddays(starttime,DaysToAdd) { 
if (starttime){
	starttime = starttime.replace(new RegExp("-","gm"),"/");
}
     
	 console.log(starttime);
    var now=new Date(starttime);  
    var newdate=new Date();  
    var newtimems=now.getTime()+(DaysToAdd*24*60*60*1000);  
            newdate.setTime(newtimems);  
    //只得到年月日的  
    return newdate.getFullYear()+"-"+(newdate.getMonth()+1)+"-"+newdate.getDate();  
    //得到具体时间  
    } 
	
	function myAjax(iUrl,iData,fun,iAsync){
	if(iAsync == undefined) iAsync = true;
	$.ajax({
		type: "GET",
		url: iUrl,
		async: iAsync,
		data: iData,
        dataType: 'json',
       // jsonp: 'callback',
		success : function(result) {
				fun(result);
		},
		error : function(result) {
			alert('系统错误');
		}
	});
}


